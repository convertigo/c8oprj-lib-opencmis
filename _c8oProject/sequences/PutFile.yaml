accessibility: Hidden
comment: |
  Puts a file in a CIMS repository. The Sequence will return the folder were the file has been placed.
  
â†“PutFile [steps.SimpleStep-1744461342356]: 
  expression: |
    'var cmis = new JavaImporter(
        org.apache.chemistry.opencmis.client.api,
        org.apache.chemistry.opencmis.client.runtime,
        org.apache.chemistry.opencmis.commons.enums,
        org.apache.chemistry.opencmis.commons,
        java.util,
        java.io
    );
    
    var error = null
    
    with (cmis) {
    	try {
    		// get CIMSSession
    		var session = context.httpSession.getAttribute("CIMSSession");
    
    	    var folder = session.getObjectByPath(folderPath);
    	    log.debug("Uploading to: " + folder.getPaths().toArray()[0]);
    	
    	    // Local file to upload
    	    var file = new File(filePath);
    	
    	    var fileName = file.getName();
    	    var fileInputStream = new FileInputStream(file);
    	    var fileLength = file.length();
    	
    		// ðŸ§  3. Try to detect MIME type
    		var mimeType = java.nio.file.Files.probeContentType(file.toPath());
    		if (mimeType == null) {
    		     mimeType = "application/octet-stream"; // fallback
    		}
    		log.debug("ðŸ§ª Detected MIME type: " + mimeType);
    		
    	    // Create CMIS content stream
    	    var contentStream = session.getObjectFactory().createContentStream(
    	        fileName,
    	        fileLength,
    	        mimeType, 
    	        fileInputStream
    	    );
    	
    	    // Document properties
    	    var props = new HashMap();
    	    props.put(PropertyIds.OBJECT_TYPE_ID, "cmis:document");
    	    props.put(PropertyIds.NAME, fileName);
    	
    	    // Upload file (create document in the folder)
    	    var newDoc = folder.createDocument(props, contentStream, VersioningState.MAJOR);
    	    log.debug("âœ… File uploaded: " + newDoc.getName());
    	    log.debug("CMIS path: " + newDoc.getPaths().toArray()[0]);
    	
    	    // Clean up
    	    fileInputStream.close();
    	} catch (e) {
    		// Handle exceptions
    		error = e.message;
    		if (e.cause) {
    			log.error("Cause: " + e.cause.message);
    		}
    	}
    }
    '
â†“jIf [steps.IfStep-1744461342359]: 
  condition: error != null
  â†“Error_structure [steps.XMLErrorStep-1744461342362]: 
    message: 
      - xmlizable: 
        - â†‘classname: com.twinsoft.convertigo.beans.steps.SmartType
        - SmartType: 
          - â†‘mode: JS
          - â†’â†’: error
  â†“Return [steps.ReturnStep-1744461342365]: 
â†“folderPath [variables.RequestableVariable-1744461342371]: 
  comment: Target path in the CIMS. for example '/MyFolder'
â†“filePath [variables.RequestableVariable-1744461634939]: 
  comment: Full Path of the file to upload to CIMS. 
â†“TestOK [core.TestCase]: 
  â†“folderPath [variables.TestCaseVariable-1744461817295]: 
    value: /MyFolder
  â†“filePath [variables.TestCaseVariable-1744461817297]: 
    value: C:\Users\opic_000\Downloads\helm-v3.17.0-linux-amd64.tar.gz